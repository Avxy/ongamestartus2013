(function(e){var b=e.shared=e.shared||{},u="js/kaiopua/core/MorphAnimator.js",x={},o;e.asset_register(u,{data:x,requirements:["js/kaiopua/utils/MathHelper.js"],callbacksOnReqs:p,wait:true});function p(y){o=y;x.options={duration:1000,durationClear:125,direction:1,interpolationDirection:1,loop:false,loopDelayPct:0,loopDelayRandom:false,loopChance:1,reverseOnComplete:false,clearOnComplete:true,startDelay:0,startAt:-1,startAtMax:false,alternate:false,alternateDelay:0,alternateDelayRandom:true,solo:false,clearOnly:false,clearExceptions:false,interruptable:true,prepare:true};x.Instance=g;x.Instance.prototype.constructor=x.Instance;x.Instance.prototype.prepare=c;x.Instance.prototype.recycle=v;x.Instance.prototype.resetTime=f;x.Instance.prototype.change=i;x.Instance.prototype.play=q;x.Instance.prototype.resume=d;x.Instance.prototype.complete=j;x.Instance.prototype.stop=m;x.Instance.prototype.clear=l;x.Instance.prototype.reset=t;x.Instance.prototype.update=h;x.Instance.prototype.reverse_direction=w;x.Instance.prototype.reverse_interpolation=n;x.Instance.prototype.get_frame_duration=s}function g(z,y,A){this.morphs=z;this.name=y;this.map=this.morphs.maps[this.name];this.options=$.extend(true,this.options||{},x.options,A);this.prepare()}function c(y){if(this.cleared!==true&&e.is_number(this.frame)){if(this.options.direction===-1){if(this.frame<0){this.frame=this.map.length-1}}else{if(this.frame>=this.map.length){this.frame=0}}}else{if(this.options.direction===-1){this.frame=this.map.length-1}else{this.frame=0}}this.frameLast=e.is_number(this.frameLast)&&this.frameLast!==this.frame?this.frameLast:-1;if(y!==true){this.animating=this.clearing=false;this.alternateTime=0}if(this.alternatingNeedsClear!==false){this.alternating=this.alternatingNeedsClear=false}this.recycle();return this}function v(){this.framesUpdated=0;this.frameTimeDelta=0;this.resetTime();return this}function f(){this.time=this.timeLast=this.timeStart=new Date().getTime();return this}function i(F){F=F||{};var B,z=F.duration,E,C,A,y,G,D;if(e.is_number(z)&&this.durationOriginal!==z){B=this.options.duration;E=this.time-this.timeStart;C=E/B;A=this.map.length;this.timeStart+=(B*C)-(z*C);y=B/A;G=z/A;D=this.frameTimeDelta/y;this.frameTimeDelta=G*D;this.durationOriginal=z}if(F.reverse===true){this.reverse_direction()}if(F.clearOnly){F.clearOnly=e.to_array(F.clearOnly)}if(F.clearExceptions){F.clearExceptions=e.to_array(F.clearExceptions)}this.options=$.extend(this.options||{},F);return this}function q(y){var z,A;if(this.clearing===true){this.clearing=false;this.recycle()}this.change(y);if(this.options.solo===true&&this.morphs.animatingNames.length>1){if(this.options.durationClear===true){this.options.durationClear=this.get_frame_duration()}if(this.options.clearOnly){this.morphs.clear_only(this.options.clearOnly,{duration:this.options.durationClear})}else{z=[this.name];if(this.options.clearExceptions){z=z.concat(this.options.clearExceptions)}if(this.alternating===true){z.push(this.options.alternate)}this.morphs.clear_all({duration:this.options.durationClear},z)}}if(this.animating!==true&&typeof this.startTimeoutHandle==="undefined"&&typeof this.loopTimeoutHandle==="undefined"){if(this.cleared!==false&&this.options.prepare!==false){this.prepare()}if(e.is_number(this.options.startAt)&&this.options.startAt>-1&&this.options.startAt<this.map.length){this.frame=this.options.startAt}if(this.options.startAtMax===true){this.morphs.mesh.morphTargetInfluences[this.map[this.frame].index]=1;this.frameTimeDelta=this.get_frame_duration()}if(this.options.startDelay===true){A=Math.round(Math.random()*this.options.duration)}else{if(e.is_number(this.options.startDelay)){A=this.options.startDelay}else{A=0}}if(A>0){this.startTimeoutHandle=window.requestTimeout($.proxy(this.resume,this),A)}else{this.resume()}}return this}function d(){if(this.animating!==true){k.call(this);this.animating=true;this.cleared=false;this.resetTime();b.signals.onGameUpdated.add(this.update,this)}return this}function j(){var B,y,z,A=false;this.options.interruptable=true;if(this.clearing===true){this.clear()}else{if(this.options.reverseOnComplete===true){this.reverse_direction()}if(this.options.loop!==true){this.stop().prepare();if(this.options.clearOnComplete===true){this.clear({duration:this.options.durationClear})}}if(typeof this.options.oneComplete==="function"){this.options.oneComplete();delete this.options.oneComplete}if(typeof this.options.onComplete==="function"){this.options.onComplete()}B=this.options.alternate;if(typeof B==="string"&&B!==this.name){this.alternateDelay=this.options.alternateDelay;if(this.options.alternateDelayRandom){this.alternateDelay+=Math.round(Math.random()*this.options.alternateDelay)}this.alternateTime+=this.options.duration;if(this.alternateTime>=this.alternateDelay){this.alternateTime=0;z=e.index_of_value(this.morphs.names,B);if(z!==-1){y=$.extend(true,{},this.options.alternateParameters);y.clearOnly=y.clearOnly||this.options.clearOnly;y.clearExceptions=y.clearExceptions||this.options.clearExceptions;A=true;this.alternateLoopDelay=y.duration||0;this.morphs.play(B,y)}}}this.alternating=A;if(this.options.loop===true){r.call(this)}}}function r(y){this.prepare(true);y=this.options.duration*this.options.loopDelayPct*(this.options.loopDelayRandom===true?Math.random():1);if(this.alternating===true){this.alternatingNeedsClear=true;y+=this.alternateLoopDelay}a.call(this,y);return this}function a(y){k.call(this);if(this.options.loopChance<1&&Math.random()>this.options.loopChance){y=Math.round(this.options.duration*(this.options.loopDelayRandom===true?Math.random():1))}if(y>0){this.stop();this.loopTimeoutHandle=window.requestTimeout($.proxy(a,this),y)}else{this.resetTime().resume()}return this}function m(){k.call(this);this.animating=false;b.signals.onGameUpdated.remove(this.update,this);return this}function l(y){var z;if(this.options.interruptable!==false){k.call(this);if(this.cleared!==true){y=y||{};z=y.duration;if(e.is_number(z)&&z>0){if(this.clearing!==true||this.durationClear!==z){this.clearing=true;this.durationClear=z;this.recycle().resume()}}else{this.reset();if(typeof this.options.oneClear==="function"){this.options.oneClear();delete this.options.oneClear}if(typeof this.options.onClear==="function"){this.options.onClear()}}}}return this}function t(){var z,y,C=this.morphs.mesh,A=C.morphTargetInfluences,B=this.map;this.cleared=true;this.stop().prepare();for(z=0,y=B.length;z<y;z++){A[B[z].index]=0}this.morphs.remove(this.name);return this}function h(C){var G,D,O=this.morphs.mesh,M=O.morphTargetInfluences,z=this.map,B=this.options,F,H=this.time-this.timeStart,E,N,L,J,A=z.length,y,I,K;if(this.clearing===true){F=this.durationClear;E=H/F;J=C/F;for(G=0,D=A;G<D;G++){I=z[G].index;M[I]=o.clamp(M[I]-J,0,1)}}else{F=B.duration*Math.max(O.scale.x,O.scale.y,O.scale.z,0.5);E=H/F;N=B.direction;L=B.interpolationDirection;y=this.get_frame_duration();J=(C/y)*L;I=z[this.frame].index;this.frameTimeDelta+=C;if(this.frameTimeDelta>=y){this.framesUpdated++;this.frameTimeDelta=Math.max(0,this.frameTimeDelta-y);M[I]=1;if(this.frameLast>-1){K=z[this.frameLast].index;M[K]=0}this.frameLast=this.frame;this.frame=this.frame+1*N;if(N===-1&&this.frame<0){this.frame=A-1}else{if(N===1&&this.frame>A-1){this.frame=0}}if(z.length===1){if(L===-1){M[I]=0}this.frameLast=-1;this.reverse_interpolation()}}else{M[I]=o.clamp(M[I]+J,0,1);if(this.frameLast>-1){K=z[this.frameLast].index;M[K]=o.clamp(M[K]-J,0,1)}}}if(E>=1||this.framesUpdated>=A){this.complete()}this.timeLast=this.time;this.time+=C}function w(){this.options.direction=-this.options.direction;if(this.map.length===1){if(this.options.direction===-1&&this.morphs.mesh.morphTargetInfluences[this.map[0]]>0){this.options.interpolationDirection=-1}this.options.direction=1}return this}function n(){this.options.interpolationDirection=-this.options.interpolationDirection;return this}function s(){var z=this.morphs.mesh,y=this.options.duration;if(z instanceof THREE.Object3D){y*=Math.max(z.scale.x,z.scale.y,z.scale.z,0.5)}return y/this.map.length}function k(){if(typeof this.loopTimeoutHandle!=="undefined"){window.clearRequestTimeout(this.loopTimeoutHandle);delete this.loopTimeoutHandle}if(typeof this.startTimeoutHandle!=="undefined"){window.clearRequestTimeout(this.startTimeoutHandle);delete this.startTimeoutHandle}return this}}(KAIOPUA));