(function(k){var d=k.shared=k.shared||{},z="js/kaiopua/characters/Player.js",b={},p,i,t,a,q,l,w;k.asset_register(z,{data:b,requirements:["js/kaiopua/characters/Character.js","js/kaiopua/ui/Tooltip.js","js/kaiopua/utils/MathHelper.js","js/kaiopua/utils/VectorHelper.js","js/kaiopua/utils/KeyHelper.js","js/kaiopua/utils/ObjectHelper.js","js/kaiopua/utils/RayHelper.js"],callbacksOnReqs:v,wait:true});function v(H,D,C,G,F,E,B){p=H;i=D;t=C;a=G;q=F;l=E;w=B;b.options={physics:{volumetric:true},actionTypes:{movement:"action_movement",targetting:"action_targetting",ui:"action_ui"},stats:{respawnOnDeath:true},movement:{move:{speed:3},jump:{speedStart:3,duration:200}},interactions:{distanceTarget:600,distance:375},dialogues:{greeting:["Hello!","Heyo!","Hi!"]}};b.Instance=s;b.Instance.prototype=new p.Instance();b.Instance.prototype.constructor=b.Instance;b.Instance.prototype.supr=p.Instance.prototype;b.Instance.prototype.set_scene=h;b.Instance.prototype.update_ui_state=g;b.Instance.prototype.die=x;b.Instance.prototype.respawn=A;b.Instance.prototype.hover=y;b.Instance.prototype.select=r;b.Instance.prototype.interact=u;b.Instance.prototype.interaction_distance_check=f;b.Instance.prototype.silence=c;b.Instance.prototype.set_keybindings=o;b.Instance.prototype.trigger_action=e;b.Instance.prototype.pause=j;b.Instance.prototype.update=m;Object.defineProperty(b.Instance.prototype,"controllable",{get:function(){return this.state.controllable},set:function(J){var I=this.state.controllable;this.state.controllable=J;if(this.state.controllable!==I){if(this.state.controllable===true){d.signals.onGameInput.add(this.trigger_action,this)}else{d.signals.onGameInput.remove(this.trigger_action,this);this.actions.clear_active()}}}});Object.defineProperty(b.Instance.prototype,"target",{get:function(){return this._target},set:function(I){this._target=I}})}function s(D){var C=this,B;D=D||{};D.name=typeof D.name==="string"&&D.name.length>0?D.name:"Hero";D.options=$.extend(true,{},b.options,D.options);D.physics=$.extend({},b.options.physics,D.physics);p.Instance.call(this,D);this.utilVec31Interactable=new THREE.Vector3();this.utilVec32Interactable=new THREE.Vector3();B=this.keybindingsDefault={};B.pointer="pointer";B.w=B.up_arrow="w";B.s=B.down_arrow="s";B.a=B.left_arrow="a";B.d=B.right_arrow="d";B.q="q";B.e="e";B["1"]="1";B["2"]="2";B["3"]="3";B["4"]="4";B["5"]="5";B["6"]="6";B.escape="escape";B.space="space";B.alwaysAvailable=[];this.set_keybindings(B);this.actions.add([{names:"w up_arrow",eventCallbacks:{down:function(){C.move_state_change("forward")},up:function(){C.move_state_change("forward",true)}},deactivateCallbacks:"up",options:{type:this.options.actionTypes.movement}},{names:"s down_arrow",eventCallbacks:{down:function(){C.move_state_change("back")},up:function(){C.move_state_change("back",true)}},deactivateCallbacks:"up",options:{type:this.options.actionTypes.movement}},{names:"a left_arrow",eventCallbacks:{down:function(){C.move_state_change("left")},up:function(){C.move_state_change("left",true)}},deactivateCallbacks:"up",options:{type:this.options.actionTypes.movement}},{names:"d right_arrow",eventCallbacks:{down:function(){C.move_state_change("right")},up:function(){C.move_state_change("right",true)}},deactivateCallbacks:"up",options:{type:this.options.actionTypes.movement}},{names:"space",eventCallbacks:{down:function(){C.move_state_change("up")},up:function(){C.move_state_change("up",true)}},deactivateCallbacks:"up",options:{type:this.options.actionTypes.movement}},{names:"pointer",eventCallbacks:{mousemove:$.proxy(this.hover,this)},activeCheck:function(){return C.targetHover instanceof THREE.Object3D},deactivateCallbacks:"mousemove",options:{type:this.options.actionTypes.targetting}},{names:"pointer",eventCallbacks:{tap:$.proxy(this.select,this),doubletap:$.proxy(this.interact,this)},activeCheck:function(){return C.target instanceof THREE.Object3D},deactivateCallbacks:"tap",options:{type:this.options.actionTypes.targetting}},{names:"pointer",eventCallbacks:{dragstart:$.proxy(function(){this.hover();d.cameraControls.rotate_start.apply(d.cameraControls,arguments)},this),drag:$.proxy(d.cameraControls.rotate,d.cameraControls),dragend:$.proxy(d.cameraControls.rotate_stop,d.cameraControls),wheel:$.proxy(d.cameraControls.zoom,d.cameraControls)},activeCheck:function(){return d.cameraControls.rotating},options:{priority:1,silencing:true}}]);this.tooltip=new i.Instance(D.tooltip);d.domElements.$playerState=$("#playerState");d.domElements.$playerHealth=$(".player-health");d.domElements.$playerHealthBar=d.domElements.$playerHealth.find(".bar");d.domElements.$playerTarget=$("#playerTarget");d.domElements.$playerTargetPortrait=$("#playerTargetPortrait");d.domElements.$playerTargetImage=$(".target-image");d.domElements.$playerTargetName=$(".target-name");d.domElements.$playerTargetInteract=$("#playerTargetInteract");this.onHurt.add(this.update_ui_state,this);this.onDead.add(this.update_ui_state,this);this.onRespawned.add(this.update_ui_state,this);this.update_ui_state()}function h(B){b.Instance.prototype.supr.set_scene.call(this,B);if(this._scene instanceof THREE.Scene){d.signals.onGamePaused.add(this.pause,this);d.signals.onGamePointerLeft.add(this.pause,this);this.controllable=true}else{d.signals.onGamePaused.remove(this.pause,this);d.signals.onGamePointerLeft.remove(this.pause,this);this.controllable=false}}function g(){var B=this.options,C=B.stats,D=this.state;d.domElements.$playerHealthBar.css("width",(D.health/C.healthMax)*100+"%")}function x(){b.Instance.prototype.supr.die.apply(this,arguments);this.controllable=false;k.dom_fade({element:d.domElements.$playerState})}function A(){b.Instance.prototype.supr.respawn.apply(this,arguments);this.face_local_direction(new THREE.Vector3(0,0,-1));d.cameraControls.target=undefined;d.cameraControls.target=this;d.cameraControls.rotateTarget=true;k.dom_fade({element:d.domElements.$playerState,opacity:1})}function n(B,C){return{pointer:C||k.get_pointer(B),camera:d.camera,far:this.options.interactions.distanceTarget+a.distance_between(this.matrixWorld.getPosition(),d.camera.position),objects:d.scene.dynamics,octrees:d.scene.octree,objectOnly:true}}function y(C){var B=true,F,G,E,D=this.targetHover;if(typeof C!=="undefined"){F=C.event||C;G=k.get_pointer(F);E=w.raycast(n.call(this,F,G));if(E instanceof THREE.Object3D&&E.interactive===true){B=false;this.targetHover=E;if(this.targetHover!==D){d.domElements.$game.css("cursor","pointer");this.tooltip.content(this.targetHover.name).show(G)}}}if(B===true){this.targetHover=undefined;if(this.targetHover!==D){d.domElements.$game.css("cursor","auto");this.tooltip.hide()}}}function r(B){var E,D=this.target,C;if(typeof B!=="undefined"){if(B instanceof THREE.Object3D){E=B}else{if(B.target instanceof THREE.Object3D){E=B.target}else{C=B.event;E=w.raycast(n.call(this,C))}}}b.Instance.prototype.supr.select.call(this,E);if(this.target===this.targetHover){this.tooltip.hide()}if(this.target!==D){if(this.target instanceof p.Instance){k.dom_fade({element:d.domElements.$playerTarget,opacity:1});d.domElements.$playerTargetImage.css("background-image","url( '"+d.pathToAssets+(this.target.options.paths.image||this.target.options.paths.assets+".png'")+")");d.domElements.$playerTargetName.html(this.target.name);d.domElements.$playerTargetInteract.off(".interact").on("tap.interact",$.proxy(this.interact,this));this.interaction_distance_check()}else{k.dom_fade({element:d.domElements.$playerTarget});d.domElements.$playerTargetInteract.off(".interact")}}}function u(){if(this.targetInteract instanceof p.Instance){this.silence()}if(this.interaction_distance_check()){this.targetInteract=this.target;this.actions.execute("communicate","greeting",{target:this.targetInteract})}else{if(this.targetHover){this.tooltip.show().content("Too far away!");this.tooltipNeedsUpdate=true}}}function f(){var E=this.options,G=E.interactions,F=this.state,B,C,D=false;if(this.target instanceof p.Instance){B=this.utilVec31Interactable.copy(this.matrixWorld.getPosition());C=this.utilVec32Interactable.copy(this.target.matrixWorld.getPosition());if(a.distance_between(B,C)<=G.distance){D=true;d.domElements.$playerTargetInteract.removeClass("disabled");if(this.tooltipNeedsUpdate===true){this.tooltipNeedsUpdate=false;this.tooltip.content(this.target.name)}}else{d.domElements.$playerTargetInteract.addClass("disabled")}}return D}function c(){b.Instance.prototype.supr.silence.apply(this,arguments);this.targetInteract=undefined}function o(B){this.keybindings=$.extend(true,this.keybindings||{},B)}function e(G,D,F){var C=this.keybindings,E=C[D]||D,B=k.index_of_value(C.alwaysAvailable,E)!==-1;if(this.state.controllable===true||B){this.actions.execute(E,F,{event:G,allowDefault:B||k.paused})}}function j(){this.hover()}function m(){var B=this.state;b.Instance.prototype.supr.update.apply(this,arguments);if(B.dead!==true&&B.moving===true){this.interaction_distance_check()}}}(KAIOPUA));